<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Winston PWA</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #conv { height: 60vh; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    #btn { padding: 10px 20px; font-size: 16px; margin-top: 10px; }
    p { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>Winston Chat</h1>
  <div id="conv"></div>
  <button id="btn">Mluv se mnou</button>

  <script>
    // registrace service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    // poÅ¾Ã¡dej o notifikace
    if ('Notification' in window && Notification.permission !== 'granted') {
      Notification.requestPermission();
    }

    const NGROK_URL = 'https://bf75-2a00-ca8-a15-96e8-5cbe-bb12-36b4-6257.ngrok-free.app'; // nahraÄ svou ngrok adresou
    const conv = document.getElementById('conv');
    const btn = document.getElementById('btn');
    const synth = window.speechSynthesis;
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    const rec = new SpeechRec();
    rec.lang = 'cs-CZ';
    rec.interimResults = false;

    btn.onclick = () => rec.start();

    rec.onresult = e => {
      const msg = e.results[0][0].transcript.trim();
      append('Ty', msg);

      // 1) NastavenÃ­ budÃ­ku
      const alarmMatch = msg.match(/^nastav budÃ­k na\s+(\d{1,2}):(\d{2})$/i);
      if (alarmMatch) {
        const hours = parseInt(alarmMatch[1], 10);
        const mins = parseInt(alarmMatch[2], 10);
        scheduleAlarm(hours, mins);
        append('Winston', `BudÃ­k nastaven na ${hours}:${mins.toString().padStart(2,'0')}`);
        return;
      }

      // jinak volÃ¡me backend
      fetch(`${NGROK_URL}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      })
      .then(r => r.json())
      .then(j => {
        append('Winston', j.reply);
        speak(j.reply);
      })
      .catch(err => {
        console.error(err);
        append('Chyba', 'Server nedostupnÃ½');
      });
    };

    function scheduleAlarm(h, m) {
      const now = new Date();
      const alarm = new Date();
      alarm.setHours(h, m, 0, 0);
      if (alarm <= now) alarm.setDate(alarm.getDate() + 1);
      const delay = alarm.getTime() - now.getTime();
      setTimeout(() => {
        new Notification('Winston BudÃ­k', {
          body: `Je ${h}:${m.toString().padStart(2,'0')}`,
          tag: 'winston-alarm'
        });
        const u = new SpeechSynthesisUtterance(`BudÃ­k. Je ${h} hodin ${m} minut`);
        u.lang = 'cs-CZ';
        synth.speak(u);
        append('Winston', `ðŸ”” Je ${h}:${m.toString().padStart(2,'0')} â€“ budÃ­k!`);
      }, delay);
    }

    function append(who, text) {
      conv.innerHTML += `<p><strong>${who}:</strong> ${text}</p>`;
      conv.scrollTop = conv.scrollHeight;
    }

    function speak(txt) {
      const u = new SpeechSynthesisUtterance(txt);
      u.lang = 'cs-CZ';
      synth.speak(u);
    }
  </script>
</body>
</html>
